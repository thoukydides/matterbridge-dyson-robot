// Matterbridge plugin for Dyson robot vacuum and air treatment devices
// Copyright Â© 2026 Alexander Thoukydides

import path from 'node:path';
import { readdir, readFile, writeFile, stat } from 'node:fs/promises';

// Suffix added by ts-interface-builder
const TI_SUFFIX = '-ti.ts';

// Process command line arguments
const cmd = process.argv.slice(0, 2).map(p => path.basename(p)).join(' ');
const [ tiDirectory ] = process.argv.slice(2);
if (!tiDirectory) {
    console.error(`Usage: ${cmd} <ti-directory>`);
    process.exit(1);
}

// Result of preprocessing a single *-ti.ts file
interface TiDetails {
    tiBase:             string;     // Base name of the type suite
    safePath:           string;     // Path to the output file
    typeSuiteMembers:   string[];   // List of type names in this type suite
    importPaths:        string[];   // List of imported type suite variable names
    modified:           boolean;    // Has the source file been modified
}

// Preprocess all of the *-ti.ts files in the specified directory
const tiFiles = await readdir(tiDirectory);
const tiDetails = new Map<string, TiDetails>();
for (const tiFile of tiFiles) {
    if (!tiFile.endsWith(TI_SUFFIX)) continue;
    const tiBase = tiFile.slice(0, -TI_SUFFIX.length);
    const tiPath   = path.join(tiDirectory, tiFile);
    const srcPath  = path.join(tiDirectory, '..', `${tiBase}.ts`);
    const safePath = path.join(tiDirectory, `${tiBase}.ts`);
    const destPath = path.join('./', `${tiBase}.js`);

    // Compare the file modification times
    const tiStat = await stat(tiPath);
    const safeStat = await stat(safePath).catch(() => null);
    const modified = !safeStat || safeStat.mtimeMs < tiStat.mtimeMs;

    // Extract the members of the exportedTypeSuite
    const tiText = await readFile(tiPath, 'utf8');
    const typeSuite = /const exportedTypeSuite: t.ITypeSuite = {(.*),\s*};/s.exec(tiText);
    if (!typeSuite) {
        console.error(`Could not find "exportedTypeSuite" in ${tiPath}`);
        continue;
    }
    const typeSuiteMembers = typeSuite[1].split(',').map(l => l.trim());

    // Check whether any external type suites are referenced
    const srcText = await readFile(srcPath, 'utf8');
    const importMatches = srcText.matchAll(/^import.*?from '(.*?)'/mgs);
    const importPaths: string[] = [];
    for (const importMatch of importMatches) {
        const importPath = importMatch[1];
        if (!importPath.endsWith('.js')) continue;
        importPaths.push(importPath);
    }

    // Store the details for this type suite
    tiDetails.set(destPath, { tiBase, safePath, typeSuiteMembers, importPaths, modified });
}

// Generate the type-safe interface for each file
for (const [destPath, { tiBase, safePath, typeSuiteMembers }] of tiDetails.entries()) {
    // Prepare import statements (recursively)
    const importStatements: string[] = [], importedTypeSuites: string[] = [];
    let modified = false;
    const addImports = (destPath: string): void => {
        const tiDetail = tiDetails.get(destPath);
        if (!tiDetail) {
            console.error(`Could not find imported type suite "${destPath}"`);
            return;
        }
        for (const importPath of tiDetail.importPaths) {
            const importTypeSuite = `importedTypeSuite${importedTypeSuites.length}`;
            importStatements.push(`import { typeSuite as ${importTypeSuite} } from '${importPath}';`);
            importedTypeSuites.push(importTypeSuite);
            addImports(path.join(importPath));
        }
        modified ||= tiDetail.modified;
    };
    addImports(destPath);

    // Skip if not modified
    // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition
    if (!modified) continue;
    console.log(`${tiBase}: Found ${typeSuiteMembers.length} types`);

    // Generate a type-safe interface
    const safeText =
`// This module was automatically generated by ${cmd}
// ${new Date().toISOString()}

import { CheckerT, createCheckers, ICheckerSuite, ITypeSuite, TType } from 'ts-interface-checker';
import { ${typeSuiteMembers.join(', ') } } from '../${tiBase}.js';
import exportedTypeSuite from './${tiBase}-ti.js';
${importStatements.join('\n')}

// Mapping of type names to types
export interface TypeMap {
${typeSuiteMembers.map(m => `    ${m}: ${m};`).join('\n')}
}

// Type definitions
export const typeSuite = exportedTypeSuite as ITypeSuite & {
${typeSuiteMembers.map(m => `    ${m}: TType;`).join('\n')}
};

// Checkers
export const checkers = createCheckers(${['typeSuite', ...importedTypeSuites].join(', ')}) as ICheckerSuite & {
${typeSuiteMembers.map(m => `    ${m}: CheckerT<${m}>;`).join('\n')}
};

// Export the checkers by default
export default checkers;
`;

    // Write the output file
    await writeFile(safePath, safeText);
}